<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>关于APP内购的一点实战经验之谈 | 杜文杰</title>
  <meta name="author" content="杜文杰">
  
  <meta name="description" content="iOS 开发者 do something for you">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="关于APP内购的一点实战经验之谈"/>
  <meta property="og:site_name" content="杜文杰"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="alternate" href="/atom.xml" title="杜文杰" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Font-Awesome -->
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <header id="header"><div class= "header-content inner">
	<div class = "alignleft col-one">
		
			<div class='avatar'>
				<img src = "/img/default/avatar.png">
              </div>
		
		<div class="header-div">
		    <h1><a href="/">杜文杰</a></h1>
		    <h2><a href="/"></a></h2>
		</div>
	</div>
	<div class = "alignright col-two">
		
	</div>
	<div class="clearfix"></div>
</div>

<div class= "header-nav">
	<div class='header-nav-content inner'>
		<div id="main-nav" class="alignleft">
		    		
		    		  <a href="/"><i class="fa fa-home"></i>Home</a>
		    		
		    		  <a href="/archives"><i class="fa fa-archive"></i>Archives</a>
		    		
		    		  <a href="/node"><i class="fa fa-book"></i>Node.js</a>
		    		
		    		  <a href="/hexo"><i class="fa fa-book"></i>Books</a>
		    		
		</div>
		<div id="sub-nav" class="alignright">
		    
		      <a href="/atom.xml"><i class="fa fa-rss"></i>Rss</a>
		    
		      <a href="/customization"><i class="fa fa-question-circle"></i>Customization</a>
		    
		      <a href="/about"><i class="fa fa-user"></i>About</a>
		    
		</div>
	</div>
	<div class="clearfix"></div>
</div>
</header>
    <div id="content" class="inner">
      <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        
        <time datetime="2017-08-02T09:09:16.000Z"><a href="/2017/08/02/aboutIAP/">2017-08-02</a></time>
        
  
    <h1 class="title">关于APP内购的一点实战经验之谈</h1>
  

    </header>

    <div class="entry">
      
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么要做内购"><span class="toc-text">为什么要做内购</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#划重点"><span class="toc-text">划重点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#协议、税务和银行业务"><span class="toc-text">协议、税务和银行业务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建APP内购买项目"><span class="toc-text">创建APP内购买项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码集成"><span class="toc-text">代码集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#添加测试账号"><span class="toc-text">添加测试账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试遇到的问题及解决"><span class="toc-text">测试遇到的问题及解决</span></a></li></ol></li></ol></li></ol>
    </div>

        <p>内购上线已经一个多月了，一直没有时间做一个总结，因为之后立马又有两个项目要做，现在闲下来，回忆一下内购路上的一些错误认识，避免其他人进坑。关于iap的文章一搜一大把，这里推荐<a href="http://www.jianshu.com/u/6aba5654805e" target="_blank" rel="noopener">走在路上的小菜鸟</a> <a href="http://www.jianshu.com/p/847edcb1488e" target="_blank" rel="noopener">《iOS Apple内购及掉单问题》</a>的一片文章，算是比较到位的，demo的话推荐<a href="https://github.com/YZQ-Nine" target="_blank" rel="noopener">YZQ_Nine</a>的<a href="https://github.com/YZQ-Nine/IAPDemo" target="_blank" rel="noopener">IAPDemo</a>，所以下面的内容就是以这个demo和《iOS Apple内购及掉单问题》为出发点慢慢说来，关于文章中没有提到的以及demo中的优缺点我下面会讲，陋识拙见，姑且言之，姑且听之。</p>
<hr>
<h2 id="为什么要做内购"><a href="#为什么要做内购" class="headerlink" title="为什么要做内购"></a>为什么要做内购</h2><p>因为博主做的是直播APP，第一版上架是没打算做充值的，打算先上了再说，然而由于是虚拟货币交易，苹果告知必须走内购路线否则不能上架，你有什么办法呢，默默听话叫爸爸，还得30%过路费。</p>
<h2 id="划重点"><a href="#划重点" class="headerlink" title="划重点"></a>划重点</h2><p>注意，看本文之前，先看完开头提的那篇文章，本文所写内容是对《iOS Apple内购及掉单问题》的补充，为避免文字啰嗦 以下以《内购》代之，所以不会对《内购》内已经指明的内容有所重复，也就是说你所看到的都是干货。</p>
<h4 id="协议、税务和银行业务"><a href="#协议、税务和银行业务" class="headerlink" title="协议、税务和银行业务"></a>协议、税务和银行业务</h4><p>关于协议的填写按照开头提到的那篇文章里的流程走就是了，基本没有问题，这里需要提到的是填写Bank Account Number的时候这个卡号也支持企业名下账号，同样 Account Holder Name 也要填写企业名。</p>
<h4 id="创建APP内购买项目"><a href="#创建APP内购买项目" class="headerlink" title="创建APP内购买项目"></a>创建APP内购买项目</h4><p>参考《内购》，<br>在“我的APP”中把创建好的APP购买项目添加进来，在这个地方有些文章说，它们说要等到APP审核过了之后才能进行测试，其实不用，在“我的APP”中添加成功之后就可以申请sandBox账户进行测试了。</p>
<h4 id="代码集成"><a href="#代码集成" class="headerlink" title="代码集成"></a>代码集成</h4><p>这块是重点，在这里我最初的做法是按照demo的思想，也就是下图的流程，见谅一些细节没有体现，</p>
<p><img src="/MoonSoilWj.github.io/2017/08/02/QQ20170804-161718@2x.png" alt="IAPDemo"></p>
<p>下面的这张流程图是我们在项目中的流程</p>
<p><img src="/MoonSoilWj.github.io/2017/08/02/QQ20170805-162415@2x.png" alt="ourIAP"></p>
<p>这两者的区别从图中明显可以看出来，我们在做的时候是没有把交易凭证储存在本地沙河的。因为考虑到用户可能存在的一个情况，在一个设备上使用充值苹果那边成功了，而我们服务端验证没有成功，这个时候，若按照第一种方案，app会把验证凭证存在本地沙河中并且告诉苹果结束这一订单，待下次重新启动的时候，app检测到本地沙河中有交易凭证就会把交易凭证发给自己的服务端。但是，若是用户卸载了app或者使用了其他设备，那么保存在本地的交易凭证就会丢失，用户就无法在我们的服务端验证成功，就需要人工服务介入查询，为了避免这个问题，我们采用第二种方案。</p>
<p>第二种方案做法是我们服务端没有验证充值成功的，就不告诉苹果服务器结束这一订单的状态，也就是不去调用<br><code>[[SKPaymentQueue defaultQueue] finishTransaction: transaction];</code>  </p>
<p>那么在下次启动的时候，苹果会主动告诉你这一单没有结束并且回调给你这一单的状态，我们就可以继续处理这一订单。等于说把有问题的订单交给苹果来帮你保存，这种云端保存省事不少。</p>
<p>《内购》中提到要是想把自己后台这边的交易单号和苹果的交易单号一一对应起来，可以把自己的单号放在交易类SKMutablePayment的applicationUsername属性中，  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SK_EXTERN_CLASS_AVAILABLE(3_0) @interface SKMutablePayment : SKPayment</span><br><span class="line">@property(nonatomic, copy, readwrite) NSString *applicationUsername NS_AVAILABLE_IOS(7_0);</span><br></pre></td></tr></table></figure>
<p>这样做是没有问题的，但是后来的使用过程中出现过一个问题，那就是，我虽然在请求交易的时候把applicationUsername传了进去，但是会出现某些时候苹果返回给我的交易没有了这个属性，这就比较尴尬了，是个坑，后来我们就不去管这个对应关系了，发起购买的时候我会向服务端请求一个订单，购买结束的时候把交易凭证传到后台，而后台无需去对应，只要这个人有待付款的订单而且productId对的上的话那么当苹果后台验证成功的时候我们就给他充值成功。</p>
<h4 id="添加测试账号"><a href="#添加测试账号" class="headerlink" title="添加测试账号"></a>添加测试账号</h4><p>参考《内购》，<br>有些文章说这些测试账号千万不要在正式环境登录，否则会被注销，bullshit，你根本就登不上好吗。测试之前只需在AppStore中将你的正式账号退出就行，然后在你的app点击充值按钮，会有弹框提示你登录。</p>
<p>另外，使用development证书打包的app都是无法使用正式App Store账号的，也就是说你想测试一下线上的内购就必须审核通过，从App Store下载下来才能测。</p>
<h4 id="测试遇到的问题及解决"><a href="#测试遇到的问题及解决" class="headerlink" title="测试遇到的问题及解决"></a>测试遇到的问题及解决</h4><ul>
<li><p>前两天测试环境突然验证不了了，苹果付款成功，但是自己的服务端却无法验证成功，原来是苹果默默把字段改掉，之前测试环境返回的类型是“SandBox”，突然变成了“ProductionSandBox”…，所以验证是失败的，无语，不过相信线上不会这么做的。</p>
</li>
<li><p>当有未结束订单的时候，重启APP会走订单监听回调，在这里千万不要APP有问题，比如崩溃😖。。一旦崩溃那么这个用户就再也进不来了，陷入崩溃的死循环中。</p>
</li>
</ul>
<hr>
<p>欢迎访问我的微博留言：<a href="http://weibo.com/3962951205/profile?topnav=1&wvr=6&is_all=1" target="_blank" rel="noopener">肚子吃撑的杜</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/开发经验/">开发经验</a>
  </div>

        
  <div class="tags">
    <a href="/tags/iap/">iap</a>, <a href="/tags/App内购/">App内购</a>
  </div>

        
  <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a title="分享到QQ空间" href="#" class="bds_qzone" data-cmd="qzone"></a><a title="分享到新浪微博" href="#" class="bds_tsina" data-cmd="tsina"></a><a title="分享到腾讯微博" href="#" class="bds_tqq" data-cmd="tqq"></a><a title="分享到人人网" href="#" class="bds_renren" data-cmd="renren"></a><a title="分享到微信" href="#" class="bds_weixin" data-cmd="weixin"></a></div>
  <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>
<!-- 返回顶部 -->
<div id="toTop">
	<a href="#">▲</a>
	<a href="#footer">▼</a>
</div></div></div>
      <aside id="sidebar" class="alignright">
        
          
<div class="widget tag">
  <h3 class="title" id="categories">Categories</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E7%BB%8F%E9%AA%8C/">开发经验</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94bug/">随笔bug</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94%E8%AE%B0%E5%BD%95/">随笔记录</a><span class="category-list-count">1</span></li></ul> 
</div>
 

        
          <div class="widget tag">
  <h3 class="title">微信公众账号</h3>
    <ul class="entry">
      <img src="/img/default/qrcode.jpg" alt="欢迎关注个人公众账号" style= "width: 100%">
    </ul>
</div>
        
          <div class="widget tag">
  <h3 class="title">Calendar</h3>
  <div id="calendar"></div>
</div>

        
          
  <div class="widget tag">
    <h3 class="title">友情链接</h3>
      <ul class="entry">
        
          <li class='link'><a href='http://xiaoyun.farbox.com' target="_blank" rel="noopener">晓晓博客</a></li>
        
          <li class='link'><a href='http://www.ituring.com.cn/users/136808' target="_blank" rel="noopener">图灵社区</a></li>
        
      </ul>
  </div>


        
          
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">公元 2018 年</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">公元 2017 年</a><span class="archive-list-count">4</span></li></ul>
  </div>

        
      </aside>
      <div class="clearfix"></div>
    </div>
  <footer id="footer"><div class="footer-content inner">
  <div class="alignleft">
  
    &copy; 2020 杜文杰
    
  </div>
  <div class="alignright">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme
    <a href="https://github.com/pengloo53/Hexo-theme-light_cn" target="_blank" rel="noopener">light_cn</a>
  </div>

  <div>
    Hosted by <a href="https://pages.coding.me" target="_blank" rel="noopener" style="font-weight: bold">Coding Pages</a>
  </div>
  
  <div class="clearfix"></div>
</div></footer>
  <script src="/js/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<!-- calendar widget -->

  <script src="/js/calendar.js"></script>
  <script src="/js/languages.js"></script>
  <script type="text/javascript">
    $(function() {
    
      $('#calendar').aCalendar('zh-CN',{single:, root:'calendar'});
    
    });
  </script>


<!-- 百度统计 -->

	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?9acf0cedd48dc53be256ede5a98c2aaa";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<!-- fancybox -->

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>